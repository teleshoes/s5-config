#!/usr/bin/perl
use strict;
use warnings;

sub run(@);

my $BASE_DIR = "$ENV{HOME}/Code/s5";
my $BACKUP_DIR = "$BASE_DIR/backup";
my $DB_DIR = "$BACKUP_DIR/backup-dbs";
my $DB_REPO = "$DB_DIR/repo";
my $SMS_DIR = "$BACKUP_DIR/backup-sms";
my $SMS_REPO = "$SMS_DIR/repo";
my $CALL_DIR = "$BACKUP_DIR/backup-call";
my $CALL_REPO = "$CALL_DIR/repo";
my $CONTACTS_DIR = "$BACKUP_DIR/backup-contacts";
my $CONTACTS_REPO = "$CONTACTS_DIR/repo";

my $COMM_TOOLS_DIR = "$BASE_DIR/comm-tools";
my $CMD_ADD_COMM_TO_REPO = "$COMM_TOOLS_DIR/add-comm-to-repo.pl";
my $CMD_SMS_DB_IMPORTER = "$COMM_TOOLS_DIR/sms_db_importer.py";
my $CMD_CALL_DB_EXTRACT = "$COMM_TOOLS_DIR/call-db-extract.pl";
my $CMD_CONTACTS_DB_EXTRACT = "$COMM_TOOLS_DIR/contacts-db-extract";
my $CMD_CONTACTS_SORT = "$COMM_TOOLS_DIR/contacts-sort.pl";

my $DATA_MOUNTPOINT = "/mnt/android-data";
my $MMSSMS_DB_REMOTE_FILE = "/data/com.android.providers.telephony/databases/mmssms.db";
my $CONTACTS_DB_REMOTE_FILE = "/data/com.android.providers.contacts/databases/contacts2.db",
my $MMS_PARTS_REMOTE_DIR = "/data/com.android.providers.telephony/app_parts",

my $MMS_PARTS_REPO = "$BACKUP_DIR/backup-mms-parts-repo";

sub main(@){
  my $host = `s5`;
  die "failed to get host" if $? != 0;
  chomp $host;

  my $now = `date +'%Y-%m-%d_%s'`;
  chomp $now;

  my $mmssmsDb = "$DB_DIR/mmssms-$now.db";
  my $contactsDb = "$DB_DIR/contacts2-$now.db";

  #########################################################
  # copy raw data (dbs, mms files) phone => computer
  #########################################################
  print "\n\n=====COPY RAW DATA\n";
  run "scp", "root\@$host:$DATA_MOUNTPOINT/$MMSSMS_DB_REMOTE_FILE", $mmssmsDb;
  run "scp", "root\@$host:$DATA_MOUNTPOINT/$CONTACTS_DB_REMOTE_FILE", $contactsDb;
  run "rsync", "-avP", "$host:$DATA_MOUNTPOINT/$MMS_PARTS_REMOTE_DIR/", "$MMS_PARTS_REPO/";

  #########################################################
  # add raw data to repos
  #########################################################
  print "\n\n=====ADD RAW DATA TO REPOS\n";
  run "sqlite3", $mmssmsDb,
    ".output $DB_REPO/mmssms-db",
    ".dump",
    ;
  run "cd $DB_REPO; git add mmssms-db; git commit -m 'mmssms db automatic commit'";

  run "sqlite3", $contactsDb,
    ".output $DB_REPO/contacts-db",
    ".dump",
    ;
  run "cd $DB_REPO; git add contacts-db; git commit -m 'contacts db automatic commit'";

  run "cd $MMS_PARTS_REPO; git add -A; git commit -m 'automatic commit'";

  #########################################################
  # parse contacts into repo
  #########################################################
  print "\n\n=====PARSE CONTACTS\n";
  my $vcfFile = "$CONTACTS_DIR/$now.vcf";
  run "$CMD_CONTACTS_DB_EXTRACT $contactsDb > $vcfFile";
  die "error running $CMD_CONTACTS_DB_EXTRACT\n" if $? != 0;
  run "cp", "-ar", $vcfFile, "$CONTACTS_REPO/contacts.vcf";
  run "$CMD_CONTACTS_SORT";
  run "cd $CONTACTS_REPO; git --no-pager diff; git add contacts.vcf; git commit -m 'automatic commit'; git status";

  #########################################################
  # parse SMS into repo
  #########################################################
  print "\n\n=====PARSE SMS\n";
  my $smsFile = "$SMS_DIR/sms-$now.sms";
  run "$CMD_SMS_DB_IMPORTER $smsFile $mmssmsDb --db-to-csv";
  die "error running $CMD_SMS_DB_IMPORTER\n" if $? != 0;
  run "$CMD_ADD_COMM_TO_REPO", "--sms", $smsFile;
  run "cd $SMS_REPO; git --no-pager diff; git add *.sms; git commit -m 'automatic commit'; git status";

  #########################################################
  # parse calls into repo
  #########################################################
  print "\n\n=====PARSE CALLS\n";
  my $callFile = "$CALL_DIR/call-$now.call";
  run "$CMD_CALL_DB_EXTRACT $contactsDb > $callFile";
  die "error running $CMD_CALL_DB_EXTRACT\n" if $? != 0;
  run "$CMD_ADD_COMM_TO_REPO", "--call", $callFile;
  run "cd $CALL_REPO; git --no-pager diff; git add *.call; git commit -m 'automatic commit'; git status";
}

sub copyDbToRepo($$){
  my ($sqliteDb, $repo) = @_;
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
